<!DOCTYPE html>
<html>
<head>
    <title>Scanner Diagnostics</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1>Scanner Diagnostics</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Camera Test</h5>
                    </div>
                    <div class="card-body">
                        <button id="testCamera" class="btn btn-primary">Test Camera Access</button>
                        <div id="cameraStatus" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Scanner Test</h5>
                    </div>
                    <div class="card-body">
                        <button id="testScanner" class="btn btn-success">Test Barcode Scanner</button>
                        <div id="scannerStatus" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Scanner Preview</h5>
                    </div>
                    <div class="card-body">
                        <div id="scannerContainer" style="position: relative; width: 100%; height: 400px; border: 2px solid #007bff; border-radius: 8px; overflow: hidden; display: none;">
                            <video id="scannerVideo" style="width: 100%; height: 100%; object-fit: cover;"></video>
                            <canvas id="scannerCanvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></canvas>
                        </div>
                        <div id="detectedCodes" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const testCameraBtn = document.getElementById('testCamera');
            const testScannerBtn = document.getElementById('testScanner');
            const cameraStatus = document.getElementById('cameraStatus');
            const scannerStatus = document.getElementById('scannerStatus');
            const scannerContainer = document.getElementById('scannerContainer');
            const scannerVideo = document.getElementById('scannerVideo');
            const detectedCodes = document.getElementById('detectedCodes');
            
            // Test camera access
            testCameraBtn.addEventListener('click', async function() {
                cameraStatus.innerHTML = '<div class="alert alert-info">Requesting camera access...</div>';
                
                try {
                    // Check if we're in a secure context
                    if (!window.isSecureContext) {
                        cameraStatus.innerHTML = '<div class="alert alert-warning">Camera requires HTTPS or localhost for production use. Current context: ' + (window.isSecureContext ? 'Secure' : 'Not Secure') + '</div>';
                        return;
                    }
                    
                    // Request camera access
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: "environment",
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        } 
                    });
                    
                    cameraStatus.innerHTML = '<div class="alert alert-success">Camera access granted!</div>';
                    
                    // Stop the stream
                    stream.getTracks().forEach(track => track.stop());
                } catch (error) {
                    console.error('Camera error:', error);
                    cameraStatus.innerHTML = '<div class="alert alert-danger">Camera access denied or unavailable: ' + error.message + '</div>';
                }
            });
            
            // Test scanner
            testScannerBtn.addEventListener('click', function() {
                scannerStatus.innerHTML = '<div class="alert alert-info">Initializing scanner...</div>';
                detectedCodes.innerHTML = '';
                scannerContainer.style.display = 'block';
                
                // Check if Quagga is loaded
                if (typeof Quagga === 'undefined') {
                    scannerStatus.innerHTML = '<div class="alert alert-danger">QuaggaJS library not loaded</div>';
                    return;
                }
                
                // Configuration for QuaggaJS
                const config = {
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: scannerVideo,
                        constraints: {
                            facingMode: "environment",
                            width: 640,
                            height: 480
                        }
                    },
                    decoder: {
                        readers: [
                            "code_128_reader",
                            "ean_reader",
                            "ean_8_reader",
                            "code_39_reader",
                            "upc_reader",
                            "upc_e_reader"
                        ]
                    },
                    locate: true,
                    locator: {
                        halfSample: true,
                        patchSize: "medium"
                    }
                };
                
                console.log('Quagga config:', config);
                
                // Initialize Quagga
                Quagga.init(config, function(err) {
                    if (err) {
                        console.error('Error initializing scanner:', err);
                        scannerStatus.innerHTML = '<div class="alert alert-danger">Error initializing scanner: ' + (err.message || err) + '</div>';
                        return;
                    }
                    
                    scannerStatus.innerHTML = '<div class="alert alert-success">Scanner initialized successfully. Point camera at a barcode.</div>';
                    
                    // Start scanning
                    Quagga.start();
                    
                    // Register callback for detected barcodes
                    Quagga.onDetected(function(result) {
                        if (result && result.codeResult && result.codeResult.code) {
                            const code = result.codeResult.code;
                            console.log('Barcode detected:', code);
                            
                            // Display detected code
                            detectedCodes.innerHTML += `
                                <div class="alert alert-success">
                                    <strong>Detected:</strong> ${code}
                                </div>
                            `;
                            
                            // Draw detection box
                            drawDetectionBox(result);
                        }
                    });
                    
                    // Add drawing of detection boxes for debugging
                    Quagga.onProcessed(function(result) {
                        const drawingCtx = Quagga.canvas.ctx.overlay;
                        const drawingCanvas = Quagga.canvas.dom.overlay;
                        
                        if (result) {
                            if (result.boxes) {
                                drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                                result.boxes.filter(function(box) {
                                    return box !== result.box;
                                }).forEach(function(box) {
                                    Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
                                });
                            }
                            
                            if (result.box) {
                                Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
                            }
                            
                            if (result.codeResult && result.codeResult.code) {
                                Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'red', lineWidth: 3});
                            }
                        }
                    });
                });
            });
            
            // Function to draw detection box
            function drawDetectionBox(result) {
                const canvas = document.getElementById('scannerCanvas');
                const ctx = canvas.getContext('2d');
                
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Draw detection box if available
                if (result.box) {
                    ctx.beginPath();
                    ctx.moveTo(result.box[0][0], result.box[0][1]);
                    for (let i = 1; i < result.box.length; i++) {
                        ctx.lineTo(result.box[i][0], result.box[i][1]);
                    }
                    ctx.closePath();
                    ctx.strokeStyle = '#00ff00';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            }
        });
    </script>
</body>
</html>