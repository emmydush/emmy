name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: ${{ secrets.TEST_DB_PASSWORD }}
          POSTGRES_USER: postgres
          POSTGRES_DB: ims_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create local_settings.py for tests
      run: |
        echo "from pathlib import Path" > inventory_management/local_settings.py
        echo "import os" >> inventory_management/local_settings.py
        echo "BASE_DIR = Path(__file__).resolve().parent.parent" >> inventory_management/local_settings.py
        echo "DATABASES = {" >> inventory_management/local_settings.py
        echo "    'default': {" >> inventory_management/local_settings.py
        echo "        'ENGINE': 'django.db.backends.postgresql'," >> inventory_management/local_settings.py
        echo "        'NAME': 'ims_db'," >> inventory_management/local_settings.py
        echo "        'USER': 'postgres'," >> inventory_management/local_settings.py
        echo "        'PASSWORD': '${{ secrets.TEST_DB_PASSWORD }}'," >> inventory_management/local_settings.py
        echo "        'HOST': 'localhost'," >> inventory_management/local_settings.py
        echo "        'PORT': '5432'," >> inventory_management/local_settings.py
        echo "    }" >> inventory_management/local_settings.py
        echo "}" >> inventory_management/local_settings.py

    - name: Run migrations
      run: python manage.py migrate

    - name: Run tests
      run: python manage.py test

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    env:
      # Use Render service credentials instead of Docker Hub credentials
      RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Trigger Render deploy
      if: env.RENDER_SERVICE_ID != '' && env.RENDER_API_KEY != ''
      env:
        RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
      run: |
        echo "Triggering deploy for Render service: $RENDER_SERVICE_ID"
        curl -sS -X POST \
          -H "Authorization: Bearer $RENDER_API_KEY" \
          -H "Content-Type: application/json" \
          "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
          -d '{}'

    - name: Fail if Render secrets are not set
      if: env.RENDER_SERVICE_ID == '' || env.RENDER_API_KEY == ''
      run: |
        echo "RENDER_SERVICE_ID or RENDER_API_KEY is not set. Set these secrets in GitHub Actions." >&2
        exit 1

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deploy to production
      env:
        RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
      run: |
        echo "Deploying to Render..."
        # Use Authorization header (safer than query param) and capture response
        RESPONSE_FILE=$(mktemp)
        HTTP_CODE=$(curl -sS -o "$RESPONSE_FILE" -w "%{http_code}" -X POST \
          -H "Authorization: Bearer $RENDER_API_KEY" \
          -H "Content-Type: application/json" \
          "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
          -d '{}') || true
        echo "Render HTTP code: $HTTP_CODE"
        cat "$RESPONSE_FILE" || true
        if [ "$HTTP_CODE" -ne 201 ]; then
          echo "Render deploy failed (HTTP $HTTP_CODE)" >&2
          exit 1
        fi