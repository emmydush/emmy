name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: testpassword
          POSTGRES_USER: testuser
          POSTGRES_DB: test_fanta_db_29se
        options: >-
          --health-cmd "pg_isready -U testuser"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432/tcp

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Wait for PostgreSQL using custom script with timeout
      run: python wait-for-db.py
      env:
        DB_HOST: localhost
        DB_PORT: 5432
        DB_TIMEOUT: 60.0

    - name: Create local_settings.py for tests
      run: |
        echo "from pathlib import Path" > inventory_management/local_settings.py
        echo "import os" >> inventory_management/local_settings.py
        echo "BASE_DIR = Path(__file__).resolve().parent.parent" >> inventory_management/local_settings.py
        echo "DATABASES = {" >> inventory_management/local_settings.py
        echo "    'default': {" >> inventory_management/local_settings.py
        echo "        'ENGINE': 'django.db.backends.postgresql'," >> inventory_management/local_settings.py
        echo "        'NAME': 'test_fanta_db_29se'," >> inventory_management/local_settings.py
        echo "        'USER': 'testuser'," >> inventory_management/local_settings.py
        echo "        'PASSWORD': 'testpassword'," >> inventory_management/local_settings.py
        echo "        'HOST': 'localhost'," >> inventory_management/local_settings.py
        echo "        'PORT': 5432," >> inventory_management/local_settings.py
        echo "    }" >> inventory_management/local_settings.py
        echo "}" >> inventory_management/local_settings.py

    - name: Run migrations
      run: python manage.py migrate

    - name: Run tests with automatic database handling
      run: |
        # Use --keepdb to reuse the test database and avoid prompts
        # Use --debug-mode to get more detailed output
        python manage.py test --keepdb --debug-mode

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    env:
      # Support both Render service credentials and deploy key methods
      RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
      RENDER_DEPLOY_KEY: ${{ secrets.RENDER_DEPLOY_KEY }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Trigger Render deploy using Deploy Key (preferred)
      if: env.RENDER_DEPLOY_KEY != ''
      env:
        RENDER_DEPLOY_KEY: ${{ secrets.RENDER_DEPLOY_KEY }}
      run: |
        echo "Triggering deploy using Render Deploy Key..."
        curl -sS -X GET \
          "https://api.render.com/deploy/srv-d4eb6tk9c44c73bntisg?key=$RENDER_DEPLOY_KEY"

    - name: Trigger Render deploy using Service ID and API Key (fallback)
      if: env.RENDER_DEPLOY_KEY == '' && env.RENDER_SERVICE_ID != '' && env.RENDER_API_KEY != ''
      env:
        RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
      run: |
        echo "Triggering deploy for Render service: $RENDER_SERVICE_ID"
        curl -sS -X POST \
          -H "Authorization: Bearer $RENDER_API_KEY" \
          -H "Content-Type: application/json" \
          "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
          -d '{}'

    - name: Fail if no Render credentials are set
      if: env.RENDER_DEPLOY_KEY == '' && (env.RENDER_SERVICE_ID == '' || env.RENDER_API_KEY == '')
      run: |
        echo "No Render deployment credentials found. Please configure either:" >&2
        echo "  1. RENDER_DEPLOY_KEY (preferred), or" >&2
        echo "  2. Both RENDER_SERVICE_ID and RENDER_API_KEY" >&2
        exit 1

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deploy to production
      env:
        RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_DEPLOY_KEY: ${{ secrets.RENDER_DEPLOY_KEY }}
      run: |
        echo "Deploying to Render..."
        
        # Prefer deploy key method if available
        if [ -n "$RENDER_DEPLOY_KEY" ]; then
          echo "Using Render Deploy Key for deployment..."
          RESPONSE_FILE=$(mktemp)
          HTTP_CODE=$(curl -sS -o "$RESPONSE_FILE" -w "%{http_code}" -X GET \
            "https://api.render.com/deploy/srv-d4eb6tk9c44c73bntisg?key=$RENDER_DEPLOY_KEY") || true
          
          echo "Render HTTP code: $HTTP_CODE"
          cat "$RESPONSE_FILE" || true
          
          # Treat any 2xx response as success
          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "Render deploy failed (HTTP $HTTP_CODE)" >&2
            exit 1
          fi
        elif [ -n "$RENDER_SERVICE_ID" ] && [ -n "$RENDER_API_KEY" ]; then
          echo "Using Service ID and API Key for deployment..."
          # Use Authorization header and capture response
          RESPONSE_FILE=$(mktemp)
          HTTP_CODE=$(curl -sS -o "$RESPONSE_FILE" -w "%{http_code}" -X POST \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -d '{}') || true
          
          echo "Render HTTP code: $HTTP_CODE"
          cat "$RESPONSE_FILE" || true
          
          # Treat any 2xx response as success (Render may return 202 Accepted)
          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "Render deploy failed (HTTP $HTTP_CODE)" >&2
            exit 1
          fi
        else
          echo "No Render deployment credentials found. Please configure either:" >&2
          echo "  1. RENDER_DEPLOY_KEY (preferred), or" >&2
          echo "  2. Both RENDER_SERVICE_ID and RENDER_API_KEY" >&2
          exit 1
        fi
        
        echo "Deployment successful!"