{% extends 'base.html' %}
{% load static %}

{% block title %}QuaggaJS Test{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1>QuaggaJS Barcode Scanner Test</h1>
    <button id="startScanner" class="btn btn-primary">Start Scanner</button>
    <button id="stopScanner" class="btn btn-secondary" disabled>Stop Scanner</button>
    <div id="scannerContainer" style="width: 100%; height: 400px; border: 2px solid #007bff; border-radius: 8px; margin-top: 20px; position: relative; overflow: hidden;">
        <video id="scannerVideo" style="width: 100%; height: 100%; object-fit: cover;"></video>
        <canvas class="drawingBuffer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></canvas>
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; height: 20%; border: 3px solid rgba(0, 255, 0, 0.8); box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);"></div>
    </div>
    <div id="status" class="mt-3 alert alert-info">Scanner not started</div>
    <div id="result" class="mt-3"></div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/quagga.min.js' %}"></script>
<script>
let scannerActive = false;

document.getElementById('startScanner').addEventListener('click', function() {
    if (typeof Quagga === 'undefined') {
        document.getElementById('status').textContent = 'QuaggaJS library not loaded';
        document.getElementById('status').className = 'mt-3 alert alert-danger';
        return;
    }

    const scannerVideo = document.getElementById('scannerVideo');
    const status = document.getElementById('status');
    
    status.textContent = 'Initializing camera...';
    status.className = 'mt-3 alert alert-warning';

    const config = {
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: scannerVideo,
            constraints: {
                facingMode: "environment",
                width: { min: 640, ideal: 1280, max: 1920 },
                height: { min: 480, ideal: 720, max: 1080 }
            }
        },
        decoder: {
            readers: [
                "code_128_reader",
                "ean_reader",
                "ean_8_reader",
                "code_39_reader",
                "upc_reader",
                "upc_e_reader",
                "codabar_reader"
            ]
        },
        locator: {
            halfSample: false,
            patchSize: "medium",
            area: {
                top: "10%",
                right: "10%",
                left: "10%",
                bottom: "10%"
            }
        },
        frequency: 10
    };

    Quagga.init(config, function(err) {
        if (err) {
            console.error('Error initializing scanner:', err);
            status.textContent = 'Error initializing camera: ' + err;
            status.className = 'mt-3 alert alert-danger';
            return;
        }
        
        status.textContent = 'Camera ready. Point camera at barcode.';
        status.className = 'mt-3 alert alert-success';
        
        Quagga.start();
        scannerActive = true;
        
        document.getElementById('startScanner').disabled = true;
        document.getElementById('stopScanner').disabled = false;
    });

    Quagga.onDetected(function(data) {
        if (scannerActive) {
            console.log('Barcode detected:', data);
            document.getElementById('result').innerHTML = `
                <div class="alert alert-success">
                    <h4>Barcode Detected!</h4>
                    <p>Code: ${data.codeResult.code}</p>
                    <p>Format: ${data.codeResult.format}</p>
                </div>
            `;
            // Stop scanner after successful detection
            stopScanner();
        }
    });
});

document.getElementById('stopScanner').addEventListener('click', stopScanner);

function stopScanner() {
    if (scannerActive) {
        try {
            Quagga.stop();
            console.log('Quagga stopped');
        } catch (e) {
            console.error('Error stopping Quagga:', e);
        }
        scannerActive = false;
        
        document.getElementById('startScanner').disabled = false;
        document.getElementById('stopScanner').disabled = true;
        document.getElementById('status').textContent = 'Scanner stopped';
        document.getElementById('status').className = 'mt-3 alert alert-info';
    }
}
</script>
{% endblock %}